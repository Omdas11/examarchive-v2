<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In Â· ExamArchive</title>

  <link rel="stylesheet" href="css/common.css" />
  <link rel="stylesheet" href="css/brand.css" />
  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/footer.css" />
  <link rel="stylesheet" href="css/avatar-popup.css" />
  <link rel="stylesheet" href="css/profile-panel.css" />
  <link rel="stylesheet" href="css/avatar.css" />

  <meta name="description" content="Sign in to ExamArchive" />
  <meta name="theme-color" content="#d32f2f" />
  <meta name="robots" content="noindex, nofollow" />

  <style>
    .auth-page {
      max-width: 420px;
      margin: 3rem auto;
      padding: 0 1rem;
    }
    .auth-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
    }
    .auth-card h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .auth-card .subtitle {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }
    .auth-field {
      margin-bottom: 1rem;
    }
    .auth-field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.4rem;
      color: var(--text);
    }
    .auth-field input {
      width: 100%;
      padding: 0.7rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-soft);
      color: var(--text);
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    .auth-field input:focus {
      outline: none;
      border-color: var(--red);
    }
    .auth-error {
      display: none;
      padding: 0.6rem 0.8rem;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      border: 1px solid var(--color-error);
      color: var(--color-error);
      background: rgba(244,67,54,0.06);
    }
    .auth-error.auth-success {
      border-color: var(--color-success);
      color: var(--color-success);
      background: rgba(76,175,80,0.06);
    }
    .auth-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }
    .btn-auth {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }
    .btn-auth:hover { opacity: 0.85; }
    .btn-auth-primary {
      background: var(--red);
      color: #fff;
    }
    .btn-auth-google {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .auth-divider {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin: 1rem 0;
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    .auth-footer {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .auth-footer a {
      color: var(--red);
      text-decoration: none;
      font-weight: 500;
    }
    .auth-footer a:hover {
      text-decoration: underline;
    }
    .forgot-link {
      text-align: right;
      margin-top: 0.25rem;
    }
    .forgot-link a {
      font-size: 0.8rem;
      color: var(--red);
      text-decoration: none;
    }
    .forgot-link a:hover { text-decoration: underline; }
    .password-input-wrap {
      position: relative;
    }
    .password-input-wrap input {
      padding-right: 2.5rem;
    }
    .password-toggle {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.25rem;
      display: flex;
      align-items: center;
    }
    .password-toggle:hover { color: var(--text); }
  </style>
</head>
<body>

  <a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>

  <div id="night-layer"></div>
  <div id="header"></div>

  <main class="auth-page" id="main-content">
    <div class="auth-card">
      <h1>Sign In</h1>
      <p class="subtitle">Welcome back to ExamArchive</p>

      <div class="auth-error" id="authError"></div>

      <div class="auth-field">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com" autocomplete="email" />
      </div>

      <div class="auth-field">
        <label for="loginPassword">Password</label>
        <div class="password-input-wrap">
          <input type="password" id="loginPassword" placeholder="Your password" autocomplete="current-password" />
          <button type="button" class="password-toggle" id="toggleLoginPassword" aria-label="Show password" tabindex="-1">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M14.12 14.12a3 3 0 11-4.24-4.24"/></svg>
          </button>
        </div>
      </div>

      <div class="forgot-link">
        <a href="#" id="forgotPasswordLink">Forgot password?</a>
      </div>

      <div class="auth-actions">
        <button class="btn-auth btn-auth-primary" id="loginBtn">Sign In</button>
      </div>

      <div class="auth-divider">or</div>

      <button class="btn-auth btn-auth-google" id="googleSignInBtn">
        <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Sign in with Google
      </button>

      <div class="auth-footer">
        Don't have an account? <a href="register.html">Create one</a>
      </div>
    </div>
  </main>

  <div id="footer"></div>

  <div id="avatar-portal"></div>
  <div id="profile-panel-portal"></div>

  <!-- Scripts -->
  <script src="js/bootstrap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.93.3"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/core/debug.js"></script>
  <script type="module" src="js/app.module.js"></script>
  <script src="js/utils/supabase-wait.js"></script>
  <script src="js/auth-controller.js"></script>
  <script src="js/common.js"></script>
  <script src="js/avatar-utils.js"></script>
  <script src="js/utils/role-utils.js"></script>
  <script src="js/svg-icons.js"></script>
  <script src="js/roles.js"></script>
  <script src="js/admin-auth.js"></script>
  <script src="js/profile-panel.js"></script>
  <script src="js/avatar-popup.js"></script>
  <script src="js/theme.js"></script>

  <script>
  (function() {
    'use strict';

    // Redirect if already logged in
    window.addEventListener('auth:ready', function(e) {
      if (e.detail.session) {
        window.location.href = 'index.html';
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      var loginBtn = document.getElementById('loginBtn');
      var googleBtn = document.getElementById('googleSignInBtn');
      var forgotLink = document.getElementById('forgotPasswordLink');
      var errorDiv = document.getElementById('authError');

      function showError(msg, isSuccess) {
        errorDiv.textContent = msg;
        errorDiv.style.display = 'block';
        if (isSuccess) {
          errorDiv.classList.add('auth-success');
        } else {
          errorDiv.classList.remove('auth-success');
        }
      }

      loginBtn.addEventListener('click', async function() {
        var email = document.getElementById('loginEmail').value.trim();
        var password = document.getElementById('loginPassword').value;
        if (!email || !password) {
          showError('Please enter email and password.');
          return;
        }
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';
        var result = await window.AuthController.signInWithPassword(email, password);
        if (result.error) {
          showError(result.error.message || 'Sign in failed.');
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
        } else {
          window.location.href = 'index.html';
        }
      });

      // Enter key submits form
      document.getElementById('loginPassword').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') loginBtn.click();
      });

      googleBtn.addEventListener('click', async function() {
        await window.AuthController.signInWithGoogle();
      });

      // Password visibility toggle
      var togglePwdBtn = document.getElementById('toggleLoginPassword');
      var pwdInput = document.getElementById('loginPassword');
      togglePwdBtn.addEventListener('click', function() {
        var isPassword = pwdInput.type === 'password';
        pwdInput.type = isPassword ? 'text' : 'password';
        togglePwdBtn.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
        togglePwdBtn.querySelector('.eye-open').style.display = isPassword ? 'none' : '';
        togglePwdBtn.querySelector('.eye-closed').style.display = isPassword ? '' : 'none';
      });

      forgotLink.addEventListener('click', async function(e) {
        e.preventDefault();
        var email = document.getElementById('loginEmail').value.trim();
        if (!email) {
          showError('Please enter your email first.');
          return;
        }
        var result = await window.AuthController.resetPassword(email);
        if (result.error) {
          showError(result.error.message || 'Reset failed.');
        } else {
          showError('Password reset email sent. Check your inbox.', true);
        }
      });
    });
  })();
  </script>

</body>
</html>
