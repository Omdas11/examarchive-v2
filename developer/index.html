<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Developer Tools · ExamArchive</title>
  
  <!-- Global styles -->
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/header.css">
  <link rel="stylesheet" href="../css/footer.css">
  <link rel="stylesheet" href="../css/profile-panel.css">
  <link rel="stylesheet" href="../css/avatar-popup.css">
  <link rel="stylesheet" href="../css/avatar.css">
  
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#d32f2f" />

  <style>
    .dev-page { max-width: 960px; margin: 0 auto; padding: 2rem 1rem; }
    .dev-page h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
    .dev-page .subtitle { color: var(--text-muted); margin-bottom: 2rem; }

    .dev-section { margin-bottom: 2rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; }
    .dev-section h2 { font-size: 1.1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .dev-section h2 .badge { background: #d32f2f; color: #fff; font-size: 0.65rem; padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 600; }

    .dev-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 0.75rem; }
    .dev-btn { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1rem; background: var(--bg-soft); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text); transition: background 0.2s; }
    .dev-btn:hover { background: var(--border); }
    .dev-btn.danger { border-color: #d32f2f44; color: #d32f2f; }
    .dev-btn.danger:hover { background: #d32f2f11; }

    .access-denied, .loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh; text-align: center; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: #d32f2f; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .confirm-modal { position: fixed; inset: 0; z-index: 10000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); }
    .confirm-modal.open { display: flex; }
    .confirm-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 90%; text-align: center; }
    .confirm-box h3 { margin-bottom: 0.75rem; color: #d32f2f; }
    .confirm-box p { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }
    .confirm-box input { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 1rem; background: var(--bg-soft); color: var(--text); }
    .confirm-actions { display: flex; gap: 0.5rem; justify-content: center; }
  </style>
</head>
<body>

  <a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>

  <div id="night-layer"></div>
  <div id="header"></div>

  <main class="dev-page" id="main-content">

    <!-- Loading State -->
    <div id="dev-loading" class="loading-state">
      <div class="spinner"></div>
      <p>Verifying Founder access...</p>
    </div>

    <!-- Access Denied -->
    <div id="dev-denied" class="access-denied" style="display: none;">
      <h2><span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span> Access Denied</h2>
      <p class="text-muted">Only the Founder can access Developer Tools.</p>
      <a href="../index.html" class="btn btn-primary" style="margin-top:1rem;">Go Home</a>
    </div>

    <!-- Developer Content -->
    <div id="dev-content" style="display: none;">

      <h1><span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></span> Developer Tools</h1>
      <p class="subtitle">Founder-only system controls and diagnostics</p>

      <!-- Data Reset Controls -->
      <div class="dev-section">
        <h2>Data Reset Controls <span class="badge">DESTRUCTIVE</span></h2>
        <div class="dev-grid">
          <button class="dev-btn danger" data-action="reset-xp" title="Reset XP for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span> Reset User XP
          </button>
          <button class="dev-btn danger" data-action="reset-achievements" title="Reset achievements for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H3V4h3M18 9h3V4h-3"/><path d="M6 4h12v6a6 6 0 01-12 0V4z"/><path d="M12 16v3"/><path d="M8 22h8"/></svg></span> Reset Achievements
          </button>
          <button class="dev-btn danger" data-action="reset-streak" title="Reset streak for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c4-2.5 7-6 7-10.5 0-3-1.5-5.5-4-7.5-.8 2-2 3-4 3-1.5 0-2.5-1-3-2.5C6 7 4 10 4 13c0 4.5 3 7.5 8 9z"/></svg></span> Reset Streak
          </button>
          <button class="dev-btn danger" data-action="reset-submissions" title="Reset submissions for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></span> Reset Submissions
          </button>
          <button class="dev-btn danger" data-action="reset-database" title="Reset entire database (hard confirm)">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></span> Reset Entire Database
          </button>
          <button class="dev-btn danger" data-action="reset-level" title="Reset level for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span> Reset Level
          </button>
          <button class="dev-btn danger" data-action="reset-role" title="Reset role to Visitor">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span> Reset Role
          </button>
          <button class="dev-btn danger" data-action="reset-username" title="Reset username for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></span> Reset Username
          </button>
          <button class="dev-btn danger" data-action="reset-displayname" title="Reset display name for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.1 2.1 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span> Reset Display Name
          </button>
          <button class="dev-btn danger" data-action="reset-cooldown" title="Reset role change cooldown for a user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 3h14M5 21h14M7 3v4a4 4 0 004 4 4 4 0 004-4V3M7 21v-4a4 4 0 014-4 4 4 0 014 4v4"/></svg></span> Reset Cooldown
          </button>
          <button class="dev-btn danger" data-action="reset-uploads" title="Reset upload stats for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></span> Reset Upload Stats
          </button>
          <button class="dev-btn danger" data-action="reset-badges" title="Reset custom badges for a single user">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L3 7v5c0 5 3.6 9.3 9 10.5 5.4-1.2 9-5.5 9-10.5V7l-9-5z"/><path d="M9 12l2 2 4-4"/></svg></span> Reset Badges
          </button>
          <button class="dev-btn danger" data-action="reset-demo-data" title="Delete all demo submissions">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg></span> Reset Demo Data
          </button>
        </div>
      </div>

      <!-- Backend Trigger Panel -->
      <div class="dev-section">
        <h2>Backend Triggers <span class="badge">SAFE</span></h2>
        <div class="dev-grid">
          <button class="dev-btn" data-action="recalc-xp">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></span> Recalculate XP
          </button>
          <button class="dev-btn" data-action="sync-levels">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span> Re-sync Levels
          </button>
          <button class="dev-btn" data-action="rebuild-achievements">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H3V4h3M18 9h3V4h-3"/><path d="M6 4h12v6a6 6 0 01-12 0V4z"/><path d="M12 16v3"/><path d="M8 22h8"/></svg></span> Rebuild Achievements
          </button>
          <button class="dev-btn" data-action="recalc-stats">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span> Recalculate Stats
          </button>
          <button class="dev-btn" data-action="regen-search">
            <span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></span> Regenerate Search Index
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Confirmation Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-box">
      <h3 id="confirmTitle">Confirm Action</h3>
      <p id="confirmDesc">This action cannot be undone.</p>
      <input type="text" id="confirmInput" placeholder="" style="display:none;" />
      <div class="confirm-actions">
        <button class="btn btn-outline" id="confirmCancel">Cancel</button>
        <button class="btn btn-red" id="confirmOk">Confirm</button>
      </div>
    </div>
  </div>

  <div id="footer"></div>
  <div id="avatar-portal"></div>
  <div id="profile-panel-portal"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.93.3"></script>
  <script type="module" src="../js/app.module.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/avatar-utils.js"></script>
  <script src="../js/utils/role-utils.js"></script>
  <script src="../js/svg-icons.js"></script>
  <script src="../js/roles.js"></script>
  <script src="../js/admin-auth.js"></script>
  <script src="../js/supabase-client.js"></script>
  <script src="../js/core/auth-ready.js"></script>
  <script src="../js/core/debug.js"></script>
  <script src="../js/auth-controller.js"></script>
  <script src="../js/profile-panel.js"></script>
  <script src="../js/avatar-popup.js"></script>
  <script src="../js/theme.js"></script>

  <script>
  (function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', async function() {
      var loading = document.getElementById('dev-loading');
      var denied = document.getElementById('dev-denied');
      var content = document.getElementById('dev-content');

      // Add 5-second timeout for verification
      var verifyTimeout = setTimeout(function() {
        if (loading.style.display !== 'none') {
          loading.style.display = 'none';
          denied.querySelector('h2').textContent = 'Verification Timeout';
          denied.querySelector('p').textContent = 'Could not verify Founder access. Please check your connection and try again.';
          denied.style.display = 'flex';
        }
      }, 5000);

      try {
        var supabase = window.getSupabase ? window.getSupabase() : null;
        if (!supabase) {
          supabase = window.waitForSupabase ? await window.waitForSupabase() : null;
        }
        if (!supabase) { clearTimeout(verifyTimeout); showDenied(); return; }

        var sessionRes = await supabase.auth.getSession();
        var session = sessionRes.data.session;
        if (!session) { clearTimeout(verifyTimeout); showDenied(); return; }

        var roleRes = await supabase.from('roles').select('primary_role').eq('user_id', session.user.id).single();
        if (!roleRes.data || roleRes.data.primary_role !== 'Founder') {
          clearTimeout(verifyTimeout);
          showDenied();
          return;
        }

        // Founder verified
        clearTimeout(verifyTimeout);
        loading.style.display = 'none';
        content.style.display = 'block';
        initDevTools(supabase, session);

      } catch (err) {
        clearTimeout(verifyTimeout);
        console.error('[DEV-TOOLS] Access check failed:', err);
        showDenied();
      }

      function showDenied() {
        loading.style.display = 'none';
        denied.style.display = 'flex';
      }
    });

    function initDevTools(supabase, session) {
      var modal = document.getElementById('confirmModal');
      var confirmTitle = document.getElementById('confirmTitle');
      var confirmDesc = document.getElementById('confirmDesc');
      var confirmInput = document.getElementById('confirmInput');
      var confirmOk = document.getElementById('confirmOk');
      var confirmCancel = document.getElementById('confirmCancel');
      var pendingAction = null;

      var UUID_RE = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;

      // Resolve email, username, or UUID → UUID
      async function resolveIdentifier(identifier) {
        var val = identifier.trim();
        if (!val) return null;
        if (UUID_RE.test(val)) return val;
        // Use RPC to look up by username or email
        var res = await supabase.rpc('lookup_user_by_identifier', { identifier: val });
        if (res.error) throw new Error('Lookup failed: ' + res.error.message);
        if (!res.data) throw new Error('User not found: ' + val);
        return res.data;
      }

      var USER_INPUT_DESC = 'Enter email, username, or UUID.';
      var USER_INPUT_PLACEHOLDER = 'Email, username, or UUID';

      function showConfirm(title, desc, needsInput, placeholder, cb) {
        confirmTitle.innerHTML = title;
        confirmDesc.textContent = desc;
        confirmInput.style.display = needsInput ? 'block' : 'none';
        confirmInput.placeholder = placeholder || '';
        confirmInput.value = '';
        modal.classList.add('open');
        pendingAction = cb;
      }

      confirmCancel.addEventListener('click', function() {
        modal.classList.remove('open');
        pendingAction = null;
      });

      confirmOk.addEventListener('click', async function() {
        if (pendingAction) {
          await pendingAction(confirmInput.value);
        }
        modal.classList.remove('open');
        pendingAction = null;
      });

      function showToast(msg, type) {
        var el = document.createElement('div');
        el.style.cssText = 'position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:8px;background:var(--surface);border:1px solid var(--border);box-shadow:0 4px 12px rgba(0,0,0,0.1);z-index:10001;max-width:400px;font-size:0.85rem;border-left:4px solid ' + (type === 'error' ? '#f44336' : '#4CAF50') + ';';
        el.textContent = msg;
        document.body.appendChild(el);
        setTimeout(function() { el.remove(); }, 4000);
      }

      // Button handlers
      document.querySelectorAll('[data-action]').forEach(function(btn) {
        btn.addEventListener('click', async function() {
          var action = btn.dataset.action;

          switch(action) {
            case 'reset-xp':
              showConfirm('Reset User XP', 'Reset XP to 0. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.rpc('reset_user_xp', { target: uuid });
                  if (res.error) throw res.error;
                  showToast('XP reset for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-achievements':
              showConfirm('Reset Achievements', 'Clear all achievements. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.rpc('reset_achievements', { target: uuid });
                  if (res.error) throw res.error;
                  showToast('Achievements cleared for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-streak':
              showConfirm('Reset Streak', 'Reset login streak. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.rpc('reset_streak', { target: uuid });
                  if (res.error) throw res.error;
                  showToast('Streak reset for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-submissions':
              showConfirm('Reset Submissions', 'Delete all submissions. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.rpc('reset_submissions', { target: uuid });
                  if (res.error) throw res.error;
                  showToast('Submissions deleted for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-database':
              showConfirm('<span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></span> RESET ENTIRE DATABASE', 'Type "RESET ALL" to confirm. This deletes ALL submissions, achievements, and resets all XP.', true, 'Type RESET ALL', async function(val) {
                if (val !== 'RESET ALL') { showToast('Confirmation text did not match.', 'error'); return; }
                btn.disabled = true;
                try {
                  await supabase.from('submissions').delete().not('id', 'is', null);
                  await supabase.from('achievements').delete().not('id', 'is', null);
                  await supabase.from('roles').update({ xp: 0, level: 0, streak_count: 0, last_login_date: null }).not('user_id', 'is', null);
                  showToast('Database reset complete.', 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'recalc-xp':
            case 'sync-levels':
              btn.disabled = true;
              try {
                var res = await supabase.rpc('recalc_levels');
                if (res.error) throw res.error;
                showToast('Levels recalculated from XP successfully.', 'success');
              } catch(e) { showToast('Failed: ' + e.message, 'error'); }
              finally { btn.disabled = false; }
              break;

            case 'rebuild-achievements':
              btn.disabled = true;
              try {
                var res = await supabase.rpc('rebuild_achievements');
                if (res.error) throw res.error;
                showToast('Achievements rebuilt successfully.', 'success');
              } catch(e) { showToast('Failed: ' + e.message, 'error'); }
              finally { btn.disabled = false; }
              break;

            case 'recalc-stats':
              showToast('Stats recalculation triggered.', 'success');
              break;
            case 'regen-search':
              showToast('Search index regeneration triggered.', 'success');
              break;

            case 'reset-level':
              showConfirm('Reset Level', 'Reset level to 0. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.from('roles').update({ level: 0 }).eq('user_id', uuid);
                  if (res.error) throw res.error;
                  showToast('Level reset for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-role':
              showConfirm('Reset Role', 'Reset role to Visitor. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.from('roles').update({ primary_role: 'Visitor', secondary_role: null, tertiary_role: null }).eq('user_id', uuid);
                  if (res.error) throw res.error;
                  showToast('Role reset to Visitor for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-username':
              showConfirm('Reset Username', 'Clear username. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.from('roles').update({ username: null }).eq('user_id', uuid);
                  if (res.error) throw res.error;
                  showToast('Username cleared for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-displayname':
              showConfirm('Reset Display Name', 'Clear display name. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.from('roles').update({ display_name: null }).eq('user_id', uuid);
                  if (res.error) throw res.error;
                  showToast('Display name cleared for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-cooldown':
              showConfirm('Reset Cooldown', 'Clear role change cooldown. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.from('roles').update({ last_role_change: null }).eq('user_id', uuid);
                  if (res.error) throw res.error;
                  showToast('Cooldown reset for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-uploads':
              showConfirm('Reset Upload Stats', 'Delete all submissions. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  await supabase.from('submissions').delete().eq('uploaded_by', uuid);
                  showToast('Upload stats reset for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-badges':
              showConfirm('Reset Badges', 'Clear all custom badges. ' + USER_INPUT_DESC, true, USER_INPUT_PLACEHOLDER, async function(raw) {
                if (!raw) return;
                btn.disabled = true;
                try {
                  var uuid = await resolveIdentifier(raw);
                  var res = await supabase.from('roles').update({ custom_badges: [] }).eq('user_id', uuid);
                  if (res.error) throw res.error;
                  showToast('Badges cleared for ' + uuid, 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;

            case 'reset-demo-data':
              showConfirm('Reset Demo Data', 'Delete all demo submissions. This cannot be undone.', false, '', async function() {
                btn.disabled = true;
                try {
                  var res = await supabase.from('submissions').delete().eq('upload_type', 'demo-paper');
                  if (res.error) throw res.error;
                  showToast('Demo data reset successfully.', 'success');
                } catch(e) { showToast('Failed: ' + e.message, 'error'); }
                finally { btn.disabled = false; }
              });
              break;
          }
        });
      });

    }
  })();
  </script>
</body>
</html>
