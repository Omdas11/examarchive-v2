import fs from "fs";
import path from "path";
import puppeteer from "puppeteer";

const SYLLABUS_ROOT = "data/syllabus";
const OUTPUT_DIR = "assets/pdfs/syllabus";

function walk(dir) {
  let results = [];
  for (const file of fs.readdirSync(dir)) {
    const full = path.join(dir, file);
    if (fs.statSync(full).isDirectory()) {
      results = results.concat(walk(full));
    } else if (file.endsWith(".json")) {
      results.push(full);
    }
  }
  return results;
}

function renderUnits(units, listMode) {
  return units.map(u => `
    <div class="unit">
      <h3>${u.title} (${u.hours} Hours)</h3>
      ${
        listMode
          ? `<ul>${u.topics.map(t => `<li>‚òê ${t}</li>`).join("")}</ul>`
          : `<p>${u.topics.join(", ")}</p>`
      }
    </div>
  `).join("");
}

function renderRefs(refs) {
  if (!refs) return "";
  const list = Array.isArray(refs) ? refs : Object.values(refs).flat();
  return `
    <h2>REFERENCES</h2>
    <ol>${list.map(r => `<li>${r}</li>`).join("")}</ol>
  `;
}

function htmlTemplate(data, listMode) {
  return `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<style>
body {
  font-family: serif;
  margin: 50px;
}
header {
  text-align: center;
}
header h1 {
  margin-bottom: 4px;
}
header .meta {
  font-weight: bold;
}
footer {
  position: fixed;
  bottom: 20px;
  left: 0;
  right: 0;
  text-align: center;
  font-size: 11px;
}
.unit { margin-bottom: 14px; }
ul { list-style: none; padding-left: 0; }
li { margin: 4px 0; }
</style>
</head>
<body>

<header>
  <h1>${data.paper_name}</h1>
  <div class="meta">${data.paper_code}</div>
  <div class="meta">${data.university}</div>
</header>

<hr />

<h2>OBJECTIVES</h2>
<p>${data.objectives || ""}</p>

<h2>COURSE CONTENT</h2>
${renderUnits(data.units || [], listMode)}

${renderRefs(data.references)}

<footer>
  Generated by ExamArchive ¬∑ <span class="pageNumber"></span>
</footer>

</body>
</html>
`;
}

(async () => {
  console.log("üöÄ Generating dual syllabus PDFs");

  const files = walk(SYLLABUS_ROOT);
  if (!files.length) {
    console.log("‚ö† No syllabus JSON files found");
    return;
  }

  fs.mkdirSync(OUTPUT_DIR, { recursive: true });

  const browser = await puppeteer.launch({ headless: "new" });
  const page = await browser.newPage();

  for (const file of files) {
    const data = JSON.parse(fs.readFileSync(file, "utf8"));
    const code = data.paper_code || path.basename(file, ".json");

    for (const mode of ["paragraph", "list"]) {
      const html = htmlTemplate(data, mode === "list");
      await page.setContent(html, { waitUntil: "networkidle0" });

      const out = path.join(
        OUTPUT_DIR,
        `${code}-${mode}.pdf`
      );

      await page.pdf({
        path: out,
        format: "A4",
        printBackground: true,
        displayHeaderFooter: true,
        footerTemplate:
          `<div style="font-size:10px;width:100%;text-align:center;">
            ExamArchive ¬∑ Page <span class="pageNumber"></span> of <span class="totalPages"></span>
           </div>`,
        headerTemplate: `<div></div>`,
        margin: { top: "60px", bottom: "60px" }
      });

      console.log(`‚úì ${out}`);
    }
  }

  await browser.close();
  console.log("üéâ PDF generation complete");
})();
