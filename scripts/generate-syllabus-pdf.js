// generate-syllabus-pdf.js
import fs from "fs";
import path from "path";
import puppeteer from "puppeteer";

const ROOT = process.cwd();
const SYLLABUS_DIR = path.join(ROOT, "data", "syllabus");
const OUTPUT_DIR = path.join(ROOT, "assets", "pdfs", "syllabus");

fs.mkdirSync(OUTPUT_DIR, { recursive: true });

const TEMPLATE = `
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>{{paper_name}}</title>
<style>
  body {
    font-family: "Times New Roman", serif;
    margin: 60px 60px 80px 60px;
    line-height: 1.5;
    color: #000;
  }
  h1 {
    text-align: center;
    font-size: 20px;
    margin-bottom: 6px;
  }
  .meta {
    text-align: center;
    font-size: 13px;
    margin-bottom: 20px;
  }
  .meta strong {
    display: block;
  }
  hr {
    margin: 14px 0;
  }
  h2 {
    font-size: 15px;
    margin-top: 18px;
    text-transform: uppercase;
  }
  h3 {
    font-size: 14px;
    margin-top: 14px;
  }
  ul {
    margin-left: 20px;
  }
  li {
    margin-bottom: 4px;
  }
  .unit {
    margin-bottom: 12px;
  }
  footer {
    position: fixed;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 11px;
    color: #555;
  }
  .watermark {
    position: fixed;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    font-size: 64px;
    color: rgba(0,0,0,0.06);
    z-index: -1;
    white-space: nowrap;
  }
</style>
</head>
<body>

<div class="watermark">ExamArchive</div>

<h1>{{paper_name}}</h1>

<div class="meta">
  <strong>{{university}}</strong>
  {{programme}} ¬∑ Semester {{semester}} ¬∑ Credits {{credits}}<br/>
  {{paper_code}}
</div>

<hr/>

<h2>Objectives</h2>
<ul>
{{objectives}}
</ul>

<h2>Course Content</h2>
{{units}}

<h2>Learning Outcomes</h2>
<ul>
{{learning_outcomes}}
</ul>

<h2>References</h2>
<ul>
{{references}}
</ul>

<footer>
  Generated by ExamArchive ¬∑ Page <span class="pageNumber"></span>
</footer>

</body>
</html>
`;

function renderObjectives(list) {
  return list.map(o => `<li>${o}</li>`).join("\n");
}

function renderUnits(units, mode) {
  return units.map(u => {
    const topics =
      mode === "list"
        ? `<ul>${u.topics.map(t => `<li>‚òê ${t}</li>`).join("")}</ul>`
        : `<p>${u.topics.join(", ")}</p>`;

    return `
      <div class="unit">
        <h3>Unit ${u.unit_no}: ${u.title} (${u.hours} Hours)</h3>
        ${topics}
      </div>
    `;
  }).join("\n");
}

function renderLearningOutcomes(list) {
  return list.map(l => `<li>${l}</li>`).join("\n");
}

function renderReferences(refs) {
  const all = [
    ...(refs.textbooks || []),
    ...(refs.additional_reading || []),
    ...(refs.online_resources || [])
  ];

  return all.map(r =>
    `<li>${r.title}${r.author ? " ‚Äì " + r.author : ""}</li>`
  ).join("\n");
}

function findJsonFiles(dir) {
  let results = [];
  for (const file of fs.readdirSync(dir)) {
    const full = path.join(dir, file);
    if (fs.statSync(full).isDirectory()) {
      results = results.concat(findJsonFiles(full));
    } else if (file.endsWith(".json")) {
      results.push(full);
    }
  }
  return results;
}

(async () => {
  console.log("üöÄ Generating syllabus PDFs");

  const browser = await puppeteer.launch({
    headless: "new",
    args: ["--no-sandbox", "--disable-setuid-sandbox"]
  });

  const page = await browser.newPage();
  const files = findJsonFiles(SYLLABUS_DIR);

  for (const file of files) {
    const data = JSON.parse(fs.readFileSync(file, "utf8"));
    const code = data.meta.paper_code;

    for (const mode of ["paragraph", "list"]) {
      const html = TEMPLATE
        .replace("{{paper_name}}", data.meta.paper_name)
        .replace("{{paper_code}}", data.meta.paper_code)
        .replace("{{programme}}", data.meta.programme)
        .replace("{{semester}}", data.meta.semester)
        .replace("{{credits}}", data.meta.credits)
        .replace("{{university}}", data.meta.university)
        .replace("{{objectives}}", renderObjectives(data.objectives || []))
        .replace("{{units}}", renderUnits(data.units || [], mode))
        .replace("{{learning_outcomes}}", renderLearningOutcomes(data.learning_outcomes || []))
        .replace("{{references}}", renderReferences(data.references || {}));

      await page.setContent(html, { waitUntil: "networkidle0" });

      const out = path.join(OUTPUT_DIR, `${code}-${mode}.pdf`);
      await page.pdf({
        path: out,
        format: "A4",
        margin: { top: "40px", bottom: "60px", left: "40px", right: "40px" }
      });

      console.log("‚úì", path.basename(out));
    }
  }

  await browser.close();
  console.log("üéâ Done");
})();
