<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Stats · ExamArchive</title>
  
  <!-- Global styles -->
  <link rel="stylesheet" href="../css/common.css">
  <link rel="stylesheet" href="../css/header.css">
  <link rel="stylesheet" href="../css/footer.css">
  <link rel="stylesheet" href="../css/profile-panel.css">
  <link rel="stylesheet" href="../css/avatar-popup.css">
  <link rel="stylesheet" href="../css/avatar.css">
  
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#d32f2f" />

  <style>
    .stats-page { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem; }
    .stats-page h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .stats-page .subtitle { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.9rem; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; text-align: center; }
    .stat-card .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--text); display: block; }
    .stat-card .stat-label { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; display: block; }
    .stat-card .stat-value.loading { color: var(--text-muted); font-size: 1rem; }

    .charts-section { margin-bottom: 2rem; }
    .charts-section h2 { font-size: 1.1rem; margin-bottom: 1rem; }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .chart-card h3 { font-size: 0.95rem; margin-bottom: 0.75rem; color: var(--text); }
    .chart-canvas { width: 100%; height: 200px; position: relative; }

    .bar-chart { display: flex; align-items: flex-end; gap: 2px; height: 160px; padding-top: 10px; }
    .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; cursor: pointer; }
    .bar { width: 100%; min-width: 6px; max-width: 24px; border-radius: 3px 3px 0 0; transition: height 0.5s ease, filter 0.15s ease; }
    .bar-col:hover .bar { filter: brightness(1.2); }
    .bar-col.active .bar { filter: brightness(1.3); outline: 2px solid rgba(255,255,255,0.5); }
    .bar-label { font-size: 0.55rem; color: var(--text-muted); margin-top: 4px; writing-mode: vertical-lr; transform: rotate(180deg); max-height: 30px; overflow: hidden; }

    .chart-tooltip {
      position: fixed;
      z-index: 10010;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.8rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      pointer-events: none;
      display: none;
      white-space: nowrap;
    }
    .chart-tooltip.visible { display: block; }
    .chart-tooltip-date { color: var(--text-muted); font-size: 0.75rem; margin-bottom: 2px; }
    .chart-tooltip-value { font-weight: 700; font-size: 0.95rem; }

    .access-denied, .loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh; text-align: center; }
    .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: #d32f2f; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .tier-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
    .tier-badge.free { background: #4CAF5022; color: #4CAF50; }
    .tier-badge.warning { background: #FF980022; color: #FF9800; }
    .tier-badge.danger { background: #f4433622; color: #f44336; }

    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .chart-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <a href="#main-content" class="sr-only sr-only-focusable">Skip to main content</a>

  <div id="night-layer"></div>
  <div id="header"></div>

  <main class="stats-page" id="main-content">

    <!-- Loading -->
    <div id="stats-loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading stats...</p>
    </div>

    <!-- Access Denied -->
    <div id="stats-denied" class="access-denied" style="display: none;">
      <h2><span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></span> Access Denied</h2>
      <p class="text-muted">Senior Moderator+ role required to view stats.</p>
      <a href="../index.html" class="btn btn-red" style="margin-top:1rem;">Go Home</a>
    </div>

    <!-- Stats Content -->
    <div id="stats-content" style="display: none;">

      <h1><span class="svg-icon" aria-hidden="true"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span> Platform Statistics</h1>
      <p class="subtitle">Real-time metrics from the ExamArchive database</p>

      <!-- Metric Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-value loading" id="s-total-users">—</span>
          <span class="stat-label">Total Users</span>
        </div>
        <div class="stat-card">
          <span class="stat-value loading" id="s-total-uploads">—</span>
          <span class="stat-label">Total Uploads</span>
        </div>
        <div class="stat-card">
          <span class="stat-value loading" id="s-approved">—</span>
          <span class="stat-label">Approved</span>
        </div>
        <div class="stat-card">
          <span class="stat-value loading" id="s-pending">—</span>
          <span class="stat-label">Pending</span>
        </div>
        <div class="stat-card">
          <span class="stat-value loading" id="s-rejected">—</span>
          <span class="stat-label">Rejected</span>
        </div>
        <div class="stat-card">
          <span class="stat-value loading" id="s-active-7d">—</span>
          <span class="stat-label">Active (7 days)</span>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-section">
        <h2>Activity (Last 30 Days)</h2>
        <div class="chart-grid">
          <div class="chart-card">
            <h3>Uploads per Day</h3>
            <div class="chart-canvas">
              <div class="bar-chart" id="chart-uploads"></div>
            </div>
          </div>
          <div class="chart-card">
            <h3>Approvals per Day</h3>
            <div class="chart-canvas">
              <div class="bar-chart" id="chart-approvals"></div>
            </div>
          </div>
          <div class="chart-card">
            <h3>New Users per Day</h3>
            <div class="chart-canvas">
              <div class="bar-chart" id="chart-users"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Free Tier Usage -->
      <div class="charts-section">
        <h2>Free Tier Usage Estimate</h2>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));">
          <div class="stat-card">
            <span class="stat-value" id="s-db-rows">—</span>
            <span class="stat-label">Database Rows (est.)</span>
            <span class="tier-badge free" id="s-db-tier" style="margin-top:0.5rem;">Free tier</span>
          </div>
          <div class="stat-card">
            <span class="stat-value" id="s-storage-est">—</span>
            <span class="stat-label">Storage (est.)</span>
            <span class="tier-badge free" id="s-storage-tier" style="margin-top:0.5rem;">Free tier</span>
          </div>
        </div>
      </div>

    </div>
  </main>

  <div id="footer"></div>
  <div id="avatar-portal"></div>
  <div id="profile-panel-portal"></div>

  <!-- Chart tooltip (shared) -->
  <div id="chart-tooltip" class="chart-tooltip" role="tooltip">
    <div class="chart-tooltip-date" id="chart-tooltip-date"></div>
    <div class="chart-tooltip-value" id="chart-tooltip-value"></div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.93.3"></script>
  <script type="module" src="../js/app.module.js"></script>
  <script src="../js/common.js"></script>
  <script src="../js/avatar-utils.js"></script>
  <script src="../js/utils/role-utils.js"></script>
  <script src="../js/svg-icons.js"></script>
  <script src="../js/roles.js"></script>
  <script src="../js/admin-auth.js"></script>
  <script src="../js/supabase-client.js"></script>
  <script src="../js/core/auth-ready.js"></script>
  <script src="../js/core/debug.js"></script>
  <script src="../js/profile-panel.js"></script>
  <script src="../js/avatar-popup.js"></script>
  <script src="../js/theme.js"></script>

  <script>
  (function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', async function() {
      var loading = document.getElementById('stats-loading');
      var denied = document.getElementById('stats-denied');
      var content = document.getElementById('stats-content');

      try {
        var supabase = window.getSupabase ? window.getSupabase() : null;
        if (!supabase) {
          supabase = window.waitForSupabase ? await window.waitForSupabase() : null;
        }
        if (!supabase) { showDenied(); return; }

        var sessionRes = await supabase.auth.getSession();
        var session = sessionRes.data.session;
        if (!session) { showDenied(); return; }

        var roleRes = await supabase.from('roles').select('primary_role').eq('user_id', session.user.id).single();
        var role = roleRes.data ? roleRes.data.primary_role : null;
        if (!role || !['Founder', 'Admin', 'Senior Moderator'].includes(role)) {
          showDenied();
          return;
        }

        loading.style.display = 'none';
        content.style.display = 'block';
        loadStats(supabase);

      } catch (err) {
        console.error('[STATS] Access check failed:', err);
        showDenied();
      }

      function showDenied() {
        loading.style.display = 'none';
        denied.style.display = 'flex';
      }
    });

    async function loadStats(supabase) {
      try {
        // Try RPC first
        var rpcRes = await supabase.rpc('get_platform_stats');
        if (rpcRes.error) throw rpcRes.error;
        var stats = rpcRes.data;
        setText('s-total-users', stats.total_users || 0);
        setText('s-total-uploads', stats.total_uploads || 0);
        setText('s-approved', stats.approved || 0);
        setText('s-pending', stats.pending || 0);
        setText('s-rejected', stats.rejected || 0);
        setText('s-active-7d', stats.active_7 || 0);
      } catch (rpcErr) {
        // Fallback: direct queries
        try {
          var usersRes = await supabase.from('roles').select('*', { count: 'exact', head: true });
          setText('s-total-users', usersRes.count || 0);

          var uploadsRes = await supabase.from('submissions').select('*', { count: 'exact', head: true });
          setText('s-total-uploads', uploadsRes.count || 0);

          var approvedRes = await supabase.from('submissions').select('*', { count: 'exact', head: true }).in('status', ['approved', 'published']);
          setText('s-approved', approvedRes.count || 0);

          var pendingRes = await supabase.from('submissions').select('*', { count: 'exact', head: true }).eq('status', 'pending');
          setText('s-pending', pendingRes.count || 0);

          var rejectedRes = await supabase.from('submissions').select('*', { count: 'exact', head: true }).eq('status', 'rejected');
          setText('s-rejected', rejectedRes.count || 0);

          var sevenDaysAgo = new Date();
          sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
          var activeRes = await supabase.from('roles').select('*', { count: 'exact', head: true }).gte('last_login_date', sevenDaysAgo.toISOString().split('T')[0]);
          setText('s-active-7d', activeRes.count || 0);
        } catch (fallbackErr) {
          setText('s-total-users', 'Error');
          setText('s-total-uploads', 'Error');
          console.error('[STATS] Failed to load stats:', fallbackErr);
        }
      }

      // Load charts
      loadCharts(supabase);

      // Free tier usage estimate
      loadFreeTierEstimate(supabase);
    }

    async function loadFreeTierEstimate(supabase) {
      // Supabase free tier limits
      var DB_ROWS_LIMIT = 500000;
      var DB_ROWS_WARNING = 400000;
      var DB_ROWS_CAUTION = 300000;
      var STORAGE_LIMIT_MB = 1000;
      var STORAGE_WARNING_MB = 900;
      var STORAGE_CAUTION_MB = 700;
      var AVG_FILE_SIZE_MB = 0.5; // estimated average submission file size

      try {
        var rolesCount = await supabase.from('roles').select('*', { count: 'exact', head: true });
        var subsCount = await supabase.from('submissions').select('*', { count: 'exact', head: true });
        var totalRows = (rolesCount.count || 0) + (subsCount.count || 0);
        setText('s-db-rows', totalRows.toLocaleString());
        var dbTier = document.getElementById('s-db-tier');
        if (dbTier) {
          if (totalRows > DB_ROWS_WARNING) { dbTier.textContent = 'Over limit'; dbTier.className = 'tier-badge danger'; }
          else if (totalRows > DB_ROWS_CAUTION) { dbTier.textContent = 'Warning'; dbTier.className = 'tier-badge warning'; }
          else { dbTier.textContent = 'Free tier'; dbTier.className = 'tier-badge free'; }
        }
        var estStorageMB = Math.round((subsCount.count || 0) * AVG_FILE_SIZE_MB);
        var storageEl = document.getElementById('s-storage-est');
        if (storageEl) storageEl.textContent = estStorageMB < 1024 ? estStorageMB + ' MB' : (estStorageMB / 1024).toFixed(1) + ' GB';
        var storageTier = document.getElementById('s-storage-tier');
        if (storageTier) {
          if (estStorageMB > STORAGE_WARNING_MB) { storageTier.textContent = 'Over limit'; storageTier.className = 'tier-badge danger'; }
          else if (estStorageMB > STORAGE_CAUTION_MB) { storageTier.textContent = 'Warning'; storageTier.className = 'tier-badge warning'; }
          else { storageTier.textContent = 'Free tier'; storageTier.className = 'tier-badge free'; }
        }
      } catch (err) {
        console.error('[STATS] Free tier estimate failed:', err);
      }
    }

    async function loadCharts(supabase) {
      var thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      var sinceDate = thirtyDaysAgo.toISOString();

      // Uploads per day
      var uploadsData = await supabase.from('submissions').select('created_at').gte('created_at', sinceDate);
      renderBarChart('chart-uploads', groupByDay(uploadsData.data || [], 'created_at'), '#d32f2f');

      // Approvals per day
      var approvalsData = await supabase.from('submissions').select('reviewed_at').in('status', ['approved', 'published']).gte('reviewed_at', sinceDate);
      renderBarChart('chart-approvals', groupByDay(approvalsData.data || [], 'reviewed_at'), '#4CAF50');

      // New users per day (using roles.created_at)
      var usersData = await supabase.from('roles').select('user_id, created_at').gte('created_at', sinceDate);
      renderBarChart('chart-users', groupByDay(usersData.data || [], 'created_at'), '#2196F3');
    }

    function groupByDay(data, field) {
      var counts = {};
      var today = new Date();
      // Initialize last 30 days
      for (var i = 29; i >= 0; i--) {
        var d = new Date(today);
        d.setDate(d.getDate() - i);
        var key = d.toISOString().split('T')[0];
        counts[key] = 0;
      }
      // Count
      data.forEach(function(item) {
        if (!item[field]) return;
        var key = new Date(item[field]).toISOString().split('T')[0];
        if (counts[key] !== undefined) counts[key]++;
      });
      return counts;
    }

    function renderBarChart(elementId, data, color) {
      var container = document.getElementById(elementId);
      if (!container) return;
      container.innerHTML = '';

      var values = Object.values(data);
      var keys = Object.keys(data);
      var max = Math.max.apply(null, values.concat([1]));

      var tooltip = document.getElementById('chart-tooltip');
      var tooltipDate = document.getElementById('chart-tooltip-date');
      var tooltipValue = document.getElementById('chart-tooltip-value');

      keys.forEach(function(key, i) {
        var val = values[i];
        var pct = (val / max) * 100;
        var col = document.createElement('div');
        col.className = 'bar-col';
        col.title = key + ': ' + val;

        var bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = Math.max(pct, 2) + '%';
        bar.style.background = val > 0 ? color : 'var(--border)';
        col.appendChild(bar);

        // Show label every 5th day
        if (i % 5 === 0) {
          var label = document.createElement('div');
          label.className = 'bar-label';
          label.textContent = key.slice(5); // MM-DD
          col.appendChild(label);
        }

        // Interactive tooltip on click
        col.addEventListener('click', function(e) {
          e.stopPropagation();
          // Deactivate all other bars in all charts
          document.querySelectorAll('.bar-col.active').forEach(function(el) { el.classList.remove('active'); });
          col.classList.add('active');
          tooltipDate.textContent = key;
          tooltipValue.textContent = val + ' ' + (val === 1 ? 'entry' : 'entries');
          tooltipValue.style.color = val > 0 ? color : 'var(--text-muted)';
          // Position tooltip near click
          var rect = col.getBoundingClientRect();
          var tipW = 140;
          var tipH = 56;
          var left = rect.left + rect.width / 2 - tipW / 2;
          var top = rect.top - tipH - 8;
          if (left < 8) left = 8;
          if (left + tipW > window.innerWidth - 8) left = window.innerWidth - tipW - 8;
          if (top < 8) top = rect.bottom + 8;
          tooltip.style.left = left + 'px';
          tooltip.style.top = top + 'px';
          tooltip.classList.add('visible');
        });

        container.appendChild(col);
      });
    }

    // Hide tooltip on outside click
    document.addEventListener('click', function() {
      var tooltip = document.getElementById('chart-tooltip');
      if (tooltip) tooltip.classList.remove('visible');
      document.querySelectorAll('.bar-col.active').forEach(function(el) { el.classList.remove('active'); });
    });

    function setText(id, val) {
      var el = document.getElementById(id);
      if (el) {
        el.textContent = val;
        el.classList.remove('loading');
      }
    }
  })();
  </script>
</body>
</html>
